<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Node.js fs.openSync() - Complete System Flow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontSize: {
              'xxs': '0.65rem',
            }
          }
        }
      }
    </script>
    <style>
      * {
        -webkit-tap-highlight-color: transparent;
      }

      .step-card {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .step-card.active {
        transform: scale(1.01);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.6);
      }
      .step-card.completed {
        opacity: 0.5;
      }
      @keyframes pulse-glow {
        0%, 100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.5); }
        50% { box-shadow: 0 0 15px rgba(59, 130, 246, 0.8); }
      }
      .pulse-glow {
        animation: pulse-glow 1.5s ease-in-out infinite;
      }

      /* Tooltip styles - mobile friendly */
      .tooltip-trigger {
        position: relative;
        cursor: help;
        border-bottom: 1px dashed currentColor;
        -webkit-tap-highlight-color: transparent;
      }
      .tooltip-content {
        display: none;
        position: fixed;
        background-color: #1e293b;
        color: #f1f5f9;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 13px;
        max-width: min(90vw, 300px);
        text-align: left;
        z-index: 9999;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        line-height: 1.5;
        font-family: system-ui, sans-serif;
        border: 1px solid #334155;
      }
      .tooltip-content.show {
        display: block;
      }

      /* Code blocks - prevent overflow */
      .code-block {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
      }
      .code-block::-webkit-scrollbar {
        height: 4px;
      }
      .code-block::-webkit-scrollbar-thumb {
        background: #475569;
        border-radius: 2px;
      }

      /* Touch-friendly scrollbar */
      ::-webkit-scrollbar {
        width: 4px;
        height: 4px;
      }
      ::-webkit-scrollbar-thumb {
        background: #475569;
        border-radius: 2px;
      }

      .layer-user { border-left: 3px solid #22c55e; }
      .layer-nodejs { border-left: 3px solid #eab308; }
      .layer-native { border-left: 3px solid #f97316; }
      .layer-kernel { border-left: 3px solid #8b5cf6; }
      .layer-fs { border-left: 3px solid #06b6d4; }
      .layer-return { border-left: 3px solid #10b981; }

      /* Overlay for closing tooltips */
      .tooltip-overlay {
        display: none;
        position: fixed;
        inset: 0;
        z-index: 9998;
      }
      .tooltip-overlay.show {
        display: block;
      }
    </style>
  </head>
  <body class="bg-slate-900 text-slate-100 min-h-screen text-sm md:text-base">

    <!-- Tooltip overlay for closing on tap outside -->
    <div id="tooltip-overlay" class="tooltip-overlay"></div>

    <!-- Header -->
    <header class="bg-slate-800 border-b border-slate-700 px-4 py-3 md:px-6 md:py-4 sticky top-0 z-50">
      <div class="max-w-4xl mx-auto">
        <h1 class="text-lg md:text-2xl font-bold flex flex-wrap items-center gap-2">
          <span class="bg-green-600 px-2 py-0.5 md:px-3 md:py-1 rounded text-xs md:text-sm font-mono">fs.openSync()</span>
          <span class="text-base md:text-2xl">File Opening Flow</span>
        </h1>
        <p class="text-slate-400 text-xs md:text-sm mt-1">
          14 steps: JavaScript ‚Üí Kernel ‚Üí Back
        </p>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-3 md:px-6 py-4 md:py-6 pb-36 md:pb-40">

      <!-- Code Display -->
      <div class="bg-slate-800 rounded-lg md:rounded-xl p-3 md:p-4 mb-4 md:mb-6 border border-slate-700">
        <div class="flex items-center gap-1.5 md:gap-2 mb-2 md:mb-3">
          <div class="w-2.5 h-2.5 md:w-3 md:h-3 rounded-full bg-red-500"></div>
          <div class="w-2.5 h-2.5 md:w-3 md:h-3 rounded-full bg-yellow-500"></div>
          <div class="w-2.5 h-2.5 md:w-3 md:h-3 rounded-full bg-green-500"></div>
          <span class="ml-2 text-slate-400 text-xs">app.js</span>
        </div>
        <div class="code-block">
          <pre class="font-mono text-xs md:text-sm text-slate-300 whitespace-pre"><code><span class="text-slate-500">// Opening a file in Node.js</span>
<span class="text-purple-400">const</span> fs = <span class="text-yellow-400">require</span>(<span class="text-green-400">'fs'</span>);

<span id="code-line" class="text-slate-300"><span class="text-purple-400">const</span> fd = fs.<span class="text-yellow-400">openSync</span>(<span class="text-green-400">'/home/user/file.txt'</span>, <span class="text-green-400">'r+'</span>);</span>

console.<span class="text-yellow-400">log</span>(<span class="text-green-400">`fd: <span class="text-orange-400">${fd}</span>`</span>);</code></pre>
        </div>
      </div>

      <!-- Layer Legend - Scrollable on mobile -->
      <div class="flex gap-2 md:gap-3 mb-4 md:mb-6 text-xxs md:text-xs overflow-x-auto pb-2 -mx-3 px-3 md:mx-0 md:px-0">
        <div class="flex items-center gap-1 shrink-0"><div class="w-2.5 h-2.5 md:w-3 md:h-3 bg-green-500 rounded"></div><span class="text-slate-400">JavaScript</span></div>
        <div class="flex items-center gap-1 shrink-0"><div class="w-2.5 h-2.5 md:w-3 md:h-3 bg-yellow-500 rounded"></div><span class="text-slate-400">Node.js</span></div>
        <div class="flex items-center gap-1 shrink-0"><div class="w-2.5 h-2.5 md:w-3 md:h-3 bg-orange-500 rounded"></div><span class="text-slate-400">libuv</span></div>
        <div class="flex items-center gap-1 shrink-0"><div class="w-2.5 h-2.5 md:w-3 md:h-3 bg-purple-500 rounded"></div><span class="text-slate-400">Kernel</span></div>
        <div class="flex items-center gap-1 shrink-0"><div class="w-2.5 h-2.5 md:w-3 md:h-3 bg-cyan-500 rounded"></div><span class="text-slate-400">FS</span></div>
        <div class="flex items-center gap-1 shrink-0"><div class="w-2.5 h-2.5 md:w-3 md:h-3 bg-emerald-500 rounded"></div><span class="text-slate-400">Return</span></div>
      </div>

      <!-- Steps Container -->
      <div class="space-y-3 md:space-y-4">

        <!-- ==================== USER SPACE ==================== -->
        <div class="text-xs font-bold text-green-400 uppercase tracking-wider flex items-center gap-2 py-1">
          <div class="h-px bg-green-800 flex-1"></div>
          <span class="shrink-0">User Space</span>
          <div class="h-px bg-green-800 flex-1"></div>
        </div>

        <!-- Step 1: JavaScript Call -->
        <div id="step-1" class="step-card layer-user bg-slate-800 rounded-lg md:rounded-xl p-3 md:p-4 border border-slate-700">
          <div class="flex items-center gap-2 mb-2 md:mb-3">
            <span class="bg-green-600 text-white text-xs font-bold w-6 h-6 md:w-7 md:h-7 rounded flex items-center justify-center">1</span>
            <span class="font-bold text-green-400 text-sm md:text-base">JavaScript: fs.openSync()</span>
          </div>

          <div class="code-block bg-slate-900 rounded p-2 md:p-3 text-xs font-mono mb-3">
            <div class="text-slate-500 mb-1">// Your code calls:</div>
            <div>fs.<span class="tooltip-trigger text-yellow-400" data-tooltip="<strong>fs.openSync()</strong> is a synchronous wrapper. It blocks the event loop until the file is opened. For async, use fs.promises.open().">openSync</span>(</div>
            <div class="pl-3"><span class="text-green-400">'/home/user/file.txt'</span>,</div>
            <div class="pl-3"><span class="tooltip-trigger text-purple-400" data-tooltip="<strong>File flags:</strong><br>'r' = read only<br>'r+' = read & write<br>'w' = write (truncate)<br>'a' = append">'r+'</span></div>
            <div>);</div>
          </div>

          <div class="bg-green-900/30 rounded p-2 md:p-3 border border-green-800 text-xs md:text-sm">
            <div class="font-bold text-green-400 mb-1.5">What happens:</div>
            <div class="space-y-1 text-slate-300">
              <div>1. V8 parses your JavaScript code</div>
              <div>2. <code class="text-green-300 text-xs">fs.openSync</code> is a native binding</div>
              <div>3. V8 looks up the C++ function</div>
              <div>4. Arguments converted: JS ‚Üí C++ types</div>
            </div>
          </div>
        </div>

        <!-- ==================== NODE.JS RUNTIME ==================== -->
        <div class="text-xs font-bold text-yellow-400 uppercase tracking-wider flex items-center gap-2 py-1">
          <div class="h-px bg-yellow-800 flex-1"></div>
          <span class="shrink-0">Node.js Runtime</span>
          <div class="h-px bg-yellow-800 flex-1"></div>
        </div>

        <!-- Step 2: V8 Engine -->
        <div id="step-2" class="step-card layer-nodejs bg-slate-800 rounded-lg md:rounded-xl p-3 md:p-4 border border-slate-700">
          <div class="flex items-center gap-2 mb-2 md:mb-3">
            <span class="bg-yellow-600 text-white text-xs font-bold w-6 h-6 md:w-7 md:h-7 rounded flex items-center justify-center">2</span>
            <span class="font-bold text-yellow-400 text-sm md:text-base">V8: Native Binding</span>
          </div>

          <div class="code-block bg-slate-900 rounded p-2 md:p-3 text-xs font-mono mb-3">
            <div class="text-slate-500">// V8 calls into Node.js:</div>
            <div><span class="text-purple-400">node</span>::<span class="text-purple-400">fs</span>::<span class="text-yellow-400">Open</span>(args)</div>
          </div>

          <div class="bg-yellow-900/30 rounded p-2 md:p-3 border border-yellow-800 text-xs md:text-sm">
            <div class="font-bold text-yellow-400 mb-1.5">What happens:</div>
            <div class="space-y-1 text-slate-300">
              <div>1. V8 sees native function (not pure JS)</div>
              <div>2. Looks up C++ pointer in <span class="tooltip-trigger text-yellow-400" data-tooltip="<strong>Binding table</strong> maps JS function names to C++ implementations.">binding table</span></div>
              <div>3. Path ‚Üí <span class="tooltip-trigger text-yellow-400" data-tooltip="<strong>v8::String</strong> is V8's internal string type. Handles UTF-8/UTF-16 conversion.">v8::String</span></div>
              <div>4. Jumps to <code class="text-yellow-300 text-xs">node::fs::Open</code></div>
            </div>
          </div>
        </div>

        <!-- Step 3: Node.js C++ -->
        <div id="step-3" class="step-card layer-nodejs bg-slate-800 rounded-lg md:rounded-xl p-3 md:p-4 border border-slate-700">
          <div class="flex items-center gap-2 mb-2 md:mb-3">
            <span class="bg-yellow-600 text-white text-xs font-bold w-6 h-6 md:w-7 md:h-7 rounded flex items-center justify-center">3</span>
            <span class="font-bold text-yellow-400 text-sm md:text-base">Node.js C++ Binding</span>
          </div>

          <div class="code-block bg-slate-900 rounded p-2 md:p-3 text-xs font-mono mb-3">
            <div class="text-slate-500">// node_file.cc</div>
            <div><span class="text-blue-400">int</span> flags = <span class="tooltip-trigger text-cyan-400" data-tooltip="<strong>StringToFlags</strong> converts:<br>'r' ‚Üí O_RDONLY<br>'r+' ‚Üí O_RDWR<br>'w' ‚Üí O_WRONLY | O_CREAT">StringToFlags</span>(<span class="text-green-400">'r+'</span>);</div>
            <div class="text-slate-500">// flags = O_RDWR (2)</div>
            <div><span class="text-yellow-400">uv_fs_open</span>(loop, req, path, flags);</div>
          </div>

          <div class="bg-yellow-900/30 rounded p-2 md:p-3 border border-yellow-800 text-xs md:text-sm">
            <div class="font-bold text-yellow-400 mb-1.5">What happens:</div>
            <div class="space-y-1 text-slate-300">
              <div>1. v8::String ‚Üí C++ <code class="text-yellow-300 text-xs">char*</code></div>
              <div>2. <code class="text-yellow-300 text-xs">'r+'</code> ‚Üí <code class="text-yellow-300 text-xs">O_RDWR</code> (integer 2)</div>
              <div>3. Mode defaults to <code class="text-yellow-300 text-xs">0o666</code></div>
              <div>4. Calls libuv's uv_fs_open()</div>
            </div>
          </div>
        </div>

        <!-- ==================== LIBUV ==================== -->
        <div class="text-xs font-bold text-orange-400 uppercase tracking-wider flex items-center gap-2 py-1">
          <div class="h-px bg-orange-800 flex-1"></div>
          <span class="shrink-0">libuv Layer</span>
          <div class="h-px bg-orange-800 flex-1"></div>
        </div>

        <!-- Step 4: libuv -->
        <div id="step-4" class="step-card layer-native bg-slate-800 rounded-lg md:rounded-xl p-3 md:p-4 border border-slate-700">
          <div class="flex items-center gap-2 mb-2 md:mb-3">
            <span class="bg-orange-600 text-white text-xs font-bold w-6 h-6 md:w-7 md:h-7 rounded flex items-center justify-center">4</span>
            <span class="font-bold text-orange-400 text-sm md:text-base">libuv: uv_fs_open()</span>
          </div>

          <div class="code-block bg-slate-900 rounded p-2 md:p-3 text-xs font-mono mb-3">
            <div class="text-slate-500">// Cross-platform I/O</div>
            <div><span class="text-blue-400">return</span> <span class="text-cyan-400">open</span>(path, <span class="tooltip-trigger text-orange-400" data-tooltip="<strong>O_RDWR</strong> (value: 2)<br>Open for reading and writing.<br><br>Other flags:<br>O_RDONLY (0) = read only<br>O_WRONLY (1) = write only<br>O_CREAT = create if missing<br>O_TRUNC = truncate to zero">O_RDWR</span>, mode);</div>
          </div>

          <div class="bg-orange-900/30 rounded p-2 md:p-3 border border-orange-800 text-xs md:text-sm">
            <div class="font-bold text-orange-400 mb-1.5">What happens:</div>
            <div class="space-y-1 text-slate-300">
              <div>1. <span class="tooltip-trigger text-orange-400" data-tooltip="<strong>libuv</strong> abstracts OS differences. Linux: open(), Windows: CreateFile()">Platform abstraction</span> layer</div>
              <div>2. Sync mode ‚Üí calls OS directly</div>
              <div>3. Handles <span class="tooltip-trigger text-orange-400" data-tooltip="<strong>EINTR</strong> = syscall interrupted by signal. libuv auto-retries.">EINTR</span> retry</div>
              <div>4. Async would use thread pool</div>
            </div>
          </div>
        </div>

        <!-- Step 5: glibc -->
        <div id="step-5" class="step-card layer-native bg-slate-800 rounded-lg md:rounded-xl p-3 md:p-4 border border-slate-700">
          <div class="flex items-center gap-2 mb-2 md:mb-3">
            <span class="bg-orange-600 text-white text-xs font-bold w-6 h-6 md:w-7 md:h-7 rounded flex items-center justify-center">5</span>
            <span class="font-bold text-orange-400 text-sm md:text-base">C Library: open()</span>
          </div>

          <div class="code-block bg-slate-900 rounded p-2 md:p-3 text-xs font-mono mb-3">
            <div class="text-slate-500">// glibc wrapper</div>
            <div><span class="text-blue-400">return</span> <span class="text-cyan-400">syscall</span>(<span class="text-purple-400">SYS_openat</span>,</div>
            <div class="pl-3"><span class="tooltip-trigger text-purple-400" data-tooltip="<strong>AT_FDCWD</strong> (-100) means 'relative to current directory'. Modern Linux uses openat() not open().">AT_FDCWD</span>, path, flags);</div>
          </div>

          <div class="bg-orange-900/30 rounded p-2 md:p-3 border border-orange-800 text-xs md:text-sm">
            <div class="font-bold text-orange-400 mb-1.5">What happens:</div>
            <div class="space-y-1 text-slate-300">
              <div>1. glibc wraps syscall</div>
              <div>2. Loads syscall # (257) into RAX</div>
              <div>3. Args into: RDI, RSI, RDX, R10</div>
              <div>4. Executes <code class="text-orange-300 text-xs">syscall</code> instruction</div>
            </div>
          </div>
        </div>

        <!-- Step 6: syscall -->
        <div id="step-6" class="step-card layer-native bg-slate-800 rounded-lg md:rounded-xl p-3 md:p-4 border border-slate-700">
          <div class="flex items-center gap-2 mb-2 md:mb-3">
            <span class="bg-orange-600 text-white text-xs font-bold w-6 h-6 md:w-7 md:h-7 rounded flex items-center justify-center">6</span>
            <span class="font-bold text-orange-400 text-sm md:text-base">CPU: syscall</span>
          </div>

          <div class="code-block bg-slate-900 rounded p-2 md:p-3 text-xs font-mono mb-3">
            <div class="text-slate-500">; x86_64 assembly</div>
            <div><span class="text-purple-400">mov</span> rax, <span class="text-orange-400">257</span>  <span class="text-slate-500">; SYS_openat</span></div>
            <div><span class="text-purple-400">mov</span> rdi, <span class="text-orange-400">-100</span> <span class="text-slate-500">; AT_FDCWD</span></div>
            <div class="text-yellow-400 font-bold">syscall       <span class="text-slate-400">; ‚Üí Kernel!</span></div>
          </div>

          <div class="bg-orange-900/30 rounded p-2 md:p-3 border border-orange-800 text-xs md:text-sm">
            <div class="font-bold text-orange-400 mb-1.5">What happens:</div>
            <div class="space-y-1 text-slate-300">
              <div>1. CPU reads syscall instruction</div>
              <div>2. <span class="tooltip-trigger text-orange-400" data-tooltip="<strong>Ring 3 ‚Üí Ring 0:</strong> User mode (limited) ‚Üí Kernel mode (full access). This is the ONLY safe way to enter kernel.">Ring 3 ‚Üí Ring 0</span> privilege change</div>
              <div>3. Saves RIP, RFLAGS</div>
              <div>4. Jumps to kernel entry point</div>
            </div>
          </div>
        </div>

        <!-- ==================== KERNEL ==================== -->
        <div class="text-xs font-bold text-purple-400 uppercase tracking-wider flex items-center gap-2 py-1">
          <div class="h-px bg-purple-800 flex-1"></div>
          <span class="shrink-0">Kernel Space</span>
          <div class="h-px bg-purple-800 flex-1"></div>
        </div>

        <!-- Step 7: Kernel Entry -->
        <div id="step-7" class="step-card layer-kernel bg-slate-800 rounded-lg md:rounded-xl p-3 md:p-4 border border-slate-700">
          <div class="flex items-center gap-2 mb-2 md:mb-3">
            <span class="bg-purple-600 text-white text-xs font-bold w-6 h-6 md:w-7 md:h-7 rounded flex items-center justify-center">7</span>
            <span class="font-bold text-purple-400 text-sm md:text-base">Kernel Entry</span>
          </div>

          <div class="code-block bg-slate-900 rounded p-2 md:p-3 text-xs font-mono mb-3">
            <div class="text-slate-500">// entry_SYSCALL_64:</div>
            <div><span class="tooltip-trigger text-purple-400" data-tooltip="<strong>SWAPGS</strong> switches GS register to kernel value, giving access to per-CPU data structures.">swapgs</span></div>
            <div>mov rsp, kernel_stack</div>
            <div>call sys_call_table[<span class="text-orange-400">257</span>]</div>
          </div>

          <div class="bg-purple-900/30 rounded p-2 md:p-3 border border-purple-800 text-xs md:text-sm">
            <div class="font-bold text-purple-400 mb-1.5">What happens:</div>
            <div class="space-y-1 text-slate-300">
              <div>1. SWAPGS ‚Üí kernel per-CPU data</div>
              <div>2. Switch to <span class="tooltip-trigger text-purple-400" data-tooltip="Each process has its own 16KB kernel stack. Separate from user stack for security.">kernel stack</span></div>
              <div>3. Save all user registers</div>
              <div>4. Lookup & call do_sys_openat2()</div>
            </div>
          </div>
        </div>

        <!-- Step 8: VFS -->
        <div id="step-8" class="step-card layer-kernel bg-slate-800 rounded-lg md:rounded-xl p-3 md:p-4 border border-slate-700">
          <div class="flex items-center gap-2 mb-2 md:mb-3">
            <span class="bg-purple-600 text-white text-xs font-bold w-6 h-6 md:w-7 md:h-7 rounded flex items-center justify-center">8</span>
            <span class="font-bold text-purple-400 text-sm md:text-base">VFS Layer</span>
          </div>

          <div class="code-block bg-slate-900 rounded p-2 md:p-3 text-xs font-mono mb-3">
            <div class="text-slate-500">// Virtual File System</div>
            <div><span class="text-yellow-400">do_filp_open</span>(dfd, pathname, flags)</div>
            <div><span class="text-yellow-400">path_openat</span>(nd, op, flags);</div>
          </div>

          <div class="bg-purple-900/30 rounded p-2 md:p-3 border border-purple-800 text-xs md:text-sm">
            <div class="font-bold text-purple-400 mb-1.5">What happens:</div>
            <div class="space-y-1 text-slate-300">
              <div>1. <span class="tooltip-trigger text-purple-400" data-tooltip="<strong>copy_from_user()</strong> safely copies path from user memory to kernel memory.">copy_from_user</span> path string</div>
              <div>2. Check <span class="tooltip-trigger text-purple-400" data-tooltip="<strong>Mount table</strong> maps paths to filesystems. /home=ext4, /proc=procfs, etc.">mount table</span> for filesystem</div>
              <div>3. Get fs-specific operations</div>
              <div>4. Begin path walk</div>
            </div>
          </div>
        </div>

        <!-- ==================== FILE SYSTEM ==================== -->
        <div class="text-xs font-bold text-cyan-400 uppercase tracking-wider flex items-center gap-2 py-1">
          <div class="h-px bg-cyan-800 flex-1"></div>
          <span class="shrink-0">File System</span>
          <div class="h-px bg-cyan-800 flex-1"></div>
        </div>

        <!-- Step 9: Path Resolution -->
        <div id="step-9" class="step-card layer-fs bg-slate-800 rounded-lg md:rounded-xl p-3 md:p-4 border border-slate-700">
          <div class="flex items-center gap-2 mb-2 md:mb-3">
            <span class="bg-cyan-600 text-white text-xs font-bold w-6 h-6 md:w-7 md:h-7 rounded flex items-center justify-center">9</span>
            <span class="font-bold text-cyan-400 text-sm md:text-base">Path Resolution</span>
          </div>

          <div class="code-block bg-slate-900 rounded p-2 md:p-3 text-xs font-mono mb-3">
            <div class="text-slate-500">// Walking the path:</div>
            <div><span class="text-cyan-400">/</span> ‚Üí inode #2</div>
            <div class="pl-2"><span class="text-cyan-400">home/</span> ‚Üí inode #131073</div>
            <div class="pl-4"><span class="text-cyan-400">user/</span> ‚Üí inode #393217</div>
            <div class="pl-6"><span class="text-yellow-400">file.txt</span> ‚Üí inode #48291 ‚úì</div>
          </div>

          <div class="bg-cyan-900/30 rounded p-2 md:p-3 border border-cyan-800 text-xs md:text-sm">
            <div class="font-bold text-cyan-400 mb-1.5">What happens:</div>
            <div class="space-y-1 text-slate-300">
              <div>1. Start at root inode (#2)</div>
              <div>2. Lookup each component in <span class="tooltip-trigger text-cyan-400" data-tooltip="<strong>dentry cache</strong> maps (parent, name) ‚Üí inode. Cache hit = instant, miss = disk read.">dcache</span></div>
              <div>3. Check 'x' permission on each dir</div>
              <div>4. If not found ‚Üí ENOENT</div>
            </div>
          </div>
        </div>

        <!-- Step 10: Permission Check -->
        <div id="step-10" class="step-card layer-fs bg-slate-800 rounded-lg md:rounded-xl p-3 md:p-4 border border-slate-700">
          <div class="flex items-center gap-2 mb-2 md:mb-3">
            <span class="bg-cyan-600 text-white text-xs font-bold w-6 h-6 md:w-7 md:h-7 rounded flex items-center justify-center">10</span>
            <span class="font-bold text-cyan-400 text-sm md:text-base">Permission Check</span>
          </div>

          <div class="code-block bg-slate-900 rounded p-2 md:p-3 text-xs font-mono mb-3">
            <div><span class="tooltip-trigger text-cyan-400" data-tooltip="<strong>-rw-r--r--</strong><br>- = regular file<br>rw- = owner read+write<br>r-- = group read<br>r-- = others read">-rw-r--r--</span> user:user file.txt</div>
            <div class="mt-1">Process UID: <span class="text-green-400">1000</span></div>
            <div>File owner: <span class="text-green-400">1000</span> ‚úì Match!</div>
            <div>Need rw, has rw <span class="text-green-400">‚úì</span></div>
          </div>

          <div class="bg-cyan-900/30 rounded p-2 md:p-3 border border-cyan-800 text-xs md:text-sm">
            <div class="font-bold text-cyan-400 mb-1.5">What happens:</div>
            <div class="space-y-1 text-slate-300">
              <div>1. Compare process UID to file UID</div>
              <div>2. <span class="tooltip-trigger text-cyan-400" data-tooltip="<strong>DAC</strong> = Discretionary Access Control. Traditional Unix permissions.">DAC</span>: Use owner bits (rw-)</div>
              <div>3. O_RDWR needs r+w ‚Üí allowed ‚úì</div>
              <div>4. If denied ‚Üí EACCES</div>
            </div>
          </div>
        </div>

        <!-- Step 11: Inode -->
        <div id="step-11" class="step-card layer-fs bg-slate-800 rounded-lg md:rounded-xl p-3 md:p-4 border border-slate-700">
          <div class="flex items-center gap-2 mb-2 md:mb-3">
            <span class="bg-cyan-600 text-white text-xs font-bold w-6 h-6 md:w-7 md:h-7 rounded flex items-center justify-center">11</span>
            <span class="font-bold text-cyan-400 text-sm md:text-base">Inode Loading</span>
          </div>

          <div class="code-block bg-slate-900 rounded p-2 md:p-3 text-xs font-mono mb-3">
            <div class="text-slate-500">// <span class="tooltip-trigger text-cyan-400" data-tooltip="<strong>inode</strong> = index node. Stores all file metadata except the name.">inode</span> #48291</div>
            <div>size: <span class="text-orange-400">4096</span> bytes</div>
            <div>blocks: <span class="text-orange-400">[1847, 1848]</span></div>
            <div>mode: <span class="text-orange-400">0644</span></div>
            <div>uid/gid: <span class="text-orange-400">1000/1000</span></div>
          </div>

          <div class="bg-cyan-900/30 rounded p-2 md:p-3 border border-cyan-800 text-xs md:text-sm">
            <div class="font-bold text-cyan-400 mb-1.5">What happens:</div>
            <div class="space-y-1 text-slate-300">
              <div>1. Check <span class="tooltip-trigger text-cyan-400" data-tooltip="<strong>inode cache</strong> keeps recently used inodes in RAM. Multiple opens share one cached inode.">inode cache</span></div>
              <div>2. If miss: read from disk</div>
              <div>3. Load metadata & block pointers</div>
              <div>4. Set up file operations</div>
            </div>
          </div>
        </div>

        <!-- Step 12: struct file -->
        <div id="step-12" class="step-card layer-fs bg-slate-800 rounded-lg md:rounded-xl p-3 md:p-4 border border-slate-700">
          <div class="flex items-center gap-2 mb-2 md:mb-3">
            <span class="bg-cyan-600 text-white text-xs font-bold w-6 h-6 md:w-7 md:h-7 rounded flex items-center justify-center">12</span>
            <span class="font-bold text-cyan-400 text-sm md:text-base">struct file</span>
          </div>

          <div class="code-block bg-slate-900 rounded p-2 md:p-3 text-xs font-mono mb-3">
            <div class="text-slate-500">// <span class="tooltip-trigger text-cyan-400" data-tooltip="<strong>struct file</strong> = Open File Description. Created per open() call. Tracks position and mode.">Open File Description</span></div>
            <div>f_pos: <span class="text-orange-400">0</span> <span class="text-slate-500">(offset)</span></div>
            <div>f_flags: <span class="tooltip-trigger text-orange-400" data-tooltip="<strong>O_RDWR</strong> (value: 2)<br>Open for reading and writing.<br><br>Stored in struct file to track how the file was opened. Used by read/write syscalls to check permissions.">O_RDWR</span></div>
            <div>f_inode: <span class="text-purple-400">‚Üí #48291</span></div>
            <div>f_count: <span class="text-orange-400">1</span></div>
          </div>

          <div class="bg-cyan-900/30 rounded p-2 md:p-3 border border-cyan-800 text-xs md:text-sm">
            <div class="font-bold text-cyan-400 mb-1.5">What happens:</div>
            <div class="space-y-1 text-slate-300">
              <div>1. Alloc from <span class="tooltip-trigger text-cyan-400" data-tooltip="<strong>slab cache</strong> = pre-allocated pool of same-size objects. O(1) allocation.">slab cache</span></div>
              <div>2. f_pos = 0 (start of file)</div>
              <div>3. Link to inode</div>
              <div>4. Copy file_operations table</div>
            </div>
          </div>
        </div>

        <!-- Step 13: FD Allocation -->
        <div id="step-13" class="step-card layer-fs bg-slate-800 rounded-lg md:rounded-xl p-3 md:p-4 border border-slate-700">
          <div class="flex items-center gap-2 mb-2 md:mb-3">
            <span class="bg-cyan-600 text-white text-xs font-bold w-6 h-6 md:w-7 md:h-7 rounded flex items-center justify-center">13</span>
            <span class="font-bold text-cyan-400 text-sm md:text-base">FD Allocation</span>
          </div>

          <div class="code-block bg-slate-900 rounded p-2 md:p-3 text-xs font-mono mb-3">
            <div class="text-slate-500">// Process fd_table[]</div>
            <div><span class="text-slate-500">[0]</span> stdin</div>
            <div><span class="text-slate-500">[1]</span> stdout</div>
            <div><span class="text-slate-500">[2]</span> stderr</div>
            <div><span class="text-yellow-400 font-bold">[3]</span> <span class="text-green-400 font-bold">‚Üí struct file*</span> ‚ú®</div>
          </div>

          <div class="bg-cyan-900/30 rounded p-2 md:p-3 border border-cyan-800 text-xs md:text-sm">
            <div class="font-bold text-cyan-400 mb-1.5">What happens:</div>
            <div class="space-y-1 text-slate-300">
              <div>1. Scan bitmap for <span class="tooltip-trigger text-cyan-400" data-tooltip="Linux always assigns the <strong>lowest free fd</strong>. That's why closing fd 0 then opening gives you 0.">lowest free slot</span></div>
              <div>2. Slots 0-2 used ‚Üí pick slot 3</div>
              <div>3. fd_array[3] = struct file*</div>
              <div>4. <span class="text-green-400 font-bold">Return 3!</span> üéâ</div>
            </div>
          </div>
        </div>

        <!-- ==================== RETURN ==================== -->
        <div class="text-xs font-bold text-emerald-400 uppercase tracking-wider flex items-center gap-2 py-1">
          <div class="h-px bg-emerald-800 flex-1"></div>
          <span class="shrink-0">Return Path</span>
          <div class="h-px bg-emerald-800 flex-1"></div>
        </div>

        <!-- Step 14: Return -->
        <div id="step-14" class="step-card layer-return bg-slate-800 rounded-lg md:rounded-xl p-3 md:p-4 border border-slate-700">
          <div class="flex items-center gap-2 mb-2 md:mb-3">
            <span class="bg-emerald-600 text-white text-xs font-bold w-6 h-6 md:w-7 md:h-7 rounded flex items-center justify-center">14</span>
            <span class="font-bold text-emerald-400 text-sm md:text-base">Return to JavaScript</span>
          </div>

          <div class="code-block bg-slate-900 rounded p-2 md:p-3 text-xs font-mono mb-3 space-y-0.5">
            <div><span class="text-purple-400">Kernel</span>: RAX = 3</div>
            <div class="pl-2 text-slate-500">‚Üì <span class="tooltip-trigger text-emerald-400" data-tooltip="<strong>SYSRET</strong> restores user registers and returns to Ring 3. Your code resumes right after syscall.">SYSRET</span></div>
            <div><span class="text-orange-400">glibc</span>: return 3</div>
            <div class="pl-2 text-slate-500">‚Üì</div>
            <div><span class="text-orange-400">libuv</span>: req‚Üíresult = 3</div>
            <div class="pl-2 text-slate-500">‚Üì</div>
            <div><span class="text-yellow-400">Node.js</span>: v8::Integer(3)</div>
            <div class="pl-2 text-slate-500">‚Üì</div>
            <div class="bg-green-900/40 p-1.5 rounded mt-1">
              <span class="text-green-400">JS</span>: <span class="text-purple-400">const</span> fd = <span class="text-orange-400 font-bold">3</span>;
            </div>
          </div>

          <div class="bg-emerald-900/30 rounded p-2 md:p-3 border border-emerald-800 text-xs md:text-sm">
            <div class="font-bold text-emerald-400 mb-1.5">What happens:</div>
            <div class="space-y-1 text-slate-300">
              <div>1. Kernel puts 3 in RAX</div>
              <div>2. SYSRET ‚Üí back to user mode</div>
              <div>3. Value bubbles up through layers</div>
              <div>4. Your <code class="text-emerald-300 text-xs">fd</code> variable = <span class="text-orange-400 font-bold">3</span></div>
            </div>
            <div class="mt-2 pt-2 border-t border-emerald-800">
              <div class="text-emerald-400 font-bold">The magic:</div>
              <div class="text-slate-300">3 is just an index! fs.readSync(fd) ‚Üí kernel looks up fd_table[3]</div>
            </div>
          </div>
        </div>

      </div>

      <!-- Final Result -->
      <div id="result-card" class="mt-4 md:mt-6 bg-gradient-to-r from-green-900/50 to-emerald-900/50 rounded-lg md:rounded-xl p-4 md:p-6 border-2 border-green-600 hidden">
        <div class="flex items-center gap-3 mb-3 md:mb-4">
          <div class="text-2xl md:text-3xl">‚úì</div>
          <div>
            <div class="font-bold text-lg md:text-xl text-green-400">File Opened!</div>
            <div class="text-slate-400 text-xs md:text-sm">14 steps completed</div>
          </div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-4">
          <div class="bg-slate-900/50 rounded p-2 md:p-3 text-center">
            <div class="text-xxs md:text-xs text-slate-400">fd</div>
            <div class="font-mono text-xl md:text-2xl text-green-400">3</div>
          </div>
          <div class="bg-slate-900/50 rounded p-2 md:p-3 text-center">
            <div class="text-xxs md:text-xs text-slate-400">offset</div>
            <div class="font-mono text-xl md:text-2xl text-green-400">0</div>
          </div>
          <div class="bg-slate-900/50 rounded p-2 md:p-3 text-center">
            <div class="text-xxs md:text-xs text-slate-400">mode</div>
            <div class="font-mono text-xl md:text-2xl text-green-400">r+</div>
          </div>
          <div class="bg-slate-900/50 rounded p-2 md:p-3 text-center">
            <div class="text-xxs md:text-xs text-slate-400">inode</div>
            <div class="font-mono text-xl md:text-2xl text-green-400">#48291</div>
          </div>
        </div>
      </div>

      <!-- Error Scenarios -->
      <div id="error-scenarios" class="mt-4 md:mt-6 hidden">
        <h3 class="text-base md:text-lg font-bold text-red-400 mb-2 md:mb-3">Possible Errors</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-3">
          <div class="bg-red-900/20 border border-red-800 rounded p-2 md:p-3">
            <div class="font-mono text-red-400 font-bold text-sm">ENOENT</div>
            <div class="text-slate-400 text-xxs md:text-xs">Not found</div>
          </div>
          <div class="bg-red-900/20 border border-red-800 rounded p-2 md:p-3">
            <div class="font-mono text-red-400 font-bold text-sm">EACCES</div>
            <div class="text-slate-400 text-xxs md:text-xs">Permission</div>
          </div>
          <div class="bg-red-900/20 border border-red-800 rounded p-2 md:p-3">
            <div class="font-mono text-red-400 font-bold text-sm">EMFILE</div>
            <div class="text-slate-400 text-xxs md:text-xs">Too many files</div>
          </div>
          <div class="bg-red-900/20 border border-red-800 rounded p-2 md:p-3">
            <div class="font-mono text-red-400 font-bold text-sm">ENOMEM</div>
            <div class="text-slate-400 text-xxs md:text-xs">Out of memory</div>
          </div>
        </div>
      </div>
    </main>

    <!-- Controls - Fixed at bottom -->
    <footer class="fixed bottom-0 left-0 right-0 bg-slate-800/98 backdrop-blur-sm border-t border-slate-700 p-3 md:p-4 z-50 safe-area-bottom">
      <div class="max-w-4xl mx-auto">
        <!-- Buttons -->
        <div class="flex justify-center gap-2 md:gap-3 mb-2 md:mb-3">
          <button
            onclick="startAnimation()"
            id="start-btn"
            class="px-4 md:px-6 py-2.5 md:py-2 bg-green-600 active:bg-green-700 text-white rounded-lg font-bold transition text-sm md:text-base touch-manipulation"
          >
            ‚ñ∂ Start
          </button>
          <button
            onclick="nextStep()"
            id="next-btn"
            class="px-4 md:px-6 py-2.5 md:py-2 bg-slate-700 active:bg-slate-600 text-white rounded-lg font-bold transition disabled:opacity-40 text-sm md:text-base touch-manipulation"
            disabled
          >
            Next ‚Üí
          </button>
          <button
            onclick="autoPlay()"
            id="auto-btn"
            class="px-4 md:px-6 py-2.5 md:py-2 bg-blue-600 active:bg-blue-700 text-white rounded-lg font-bold transition disabled:opacity-40 text-sm md:text-base touch-manipulation"
            disabled
          >
            ‚è© Auto
          </button>
          <button
            onclick="reset()"
            class="px-4 md:px-6 py-2.5 md:py-2 bg-slate-700 active:bg-slate-600 text-white rounded-lg font-bold transition text-sm md:text-base touch-manipulation"
          >
            ‚Ü∫
          </button>
        </div>
        <!-- Progress -->
        <div class="flex items-center gap-2">
          <div class="flex-1 bg-slate-700 rounded-full h-2 md:h-2.5 overflow-hidden">
            <div id="progress-bar" class="bg-gradient-to-r from-green-500 via-purple-500 to-emerald-500 h-full transition-all duration-500" style="width: 0%"></div>
          </div>
          <div id="step-indicator" class="text-xs md:text-sm text-slate-400 font-mono w-12 text-right">0/14</div>
        </div>
      </div>
    </footer>

    <!-- Tooltip container -->
    <div id="tooltip-container" class="tooltip-content"></div>

    <script>
      // State
      let currentStep = 0;
      const totalSteps = 14;
      let isPlaying = false;
      let playInterval = null;
      let activeTooltip = null;

      // DOM elements
      const tooltipContainer = document.getElementById('tooltip-container');
      const tooltipOverlay = document.getElementById('tooltip-overlay');

      // Update UI based on current step
      function updateUI() {
        document.getElementById('progress-bar').style.width = `${(currentStep / totalSteps) * 100}%`;
        document.getElementById('step-indicator').textContent = `${currentStep}/${totalSteps}`;

        for (let i = 1; i <= totalSteps; i++) {
          const card = document.getElementById(`step-${i}`);
          card.classList.remove('active', 'completed', 'pulse-glow');

          if (i < currentStep) {
            card.classList.add('completed');
          } else if (i === currentStep) {
            card.classList.add('active', 'pulse-glow');
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }

        const resultCard = document.getElementById('result-card');
        const errorScenarios = document.getElementById('error-scenarios');
        if (currentStep > totalSteps) {
          resultCard.classList.remove('hidden');
          errorScenarios.classList.remove('hidden');
          resultCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
          resultCard.classList.add('hidden');
          errorScenarios.classList.add('hidden');
        }
      }

      function startAnimation() {
        currentStep = 1;
        updateUI();
        document.getElementById('next-btn').disabled = false;
        document.getElementById('auto-btn').disabled = false;
        document.getElementById('start-btn').disabled = true;
      }

      function nextStep() {
        if (currentStep <= totalSteps) {
          currentStep++;
          updateUI();
          if (currentStep > totalSteps) {
            document.getElementById('next-btn').disabled = true;
            document.getElementById('auto-btn').disabled = true;
            stopAutoPlay();
          }
        }
      }

      function autoPlay() {
        if (isPlaying) {
          stopAutoPlay();
          return;
        }
        isPlaying = true;
        const btn = document.getElementById('auto-btn');
        btn.textContent = '‚è∏ Pause';
        btn.classList.remove('bg-blue-600', 'active:bg-blue-700');
        btn.classList.add('bg-amber-600', 'active:bg-amber-700');

        playInterval = setInterval(() => {
          if (currentStep > totalSteps) {
            stopAutoPlay();
            return;
          }
          nextStep();
        }, 2000);
      }

      function stopAutoPlay() {
        isPlaying = false;
        if (playInterval) {
          clearInterval(playInterval);
          playInterval = null;
        }
        const btn = document.getElementById('auto-btn');
        btn.textContent = '‚è© Auto';
        btn.classList.remove('bg-amber-600', 'active:bg-amber-700');
        btn.classList.add('bg-blue-600', 'active:bg-blue-700');
      }

      function reset() {
        stopAutoPlay();
        currentStep = 0;
        updateUI();
        document.getElementById('start-btn').disabled = false;
        document.getElementById('next-btn').disabled = true;
        document.getElementById('auto-btn').disabled = true;
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      // Tooltip system - works for both touch and mouse
      let hideTimeout = null;
      let isHoveringTooltip = false;
      let isTouchInteraction = false;

      function showTooltip(element, html, fromTouch = false) {
        // Clear any pending hide
        if (hideTimeout) {
          clearTimeout(hideTimeout);
          hideTimeout = null;
        }

        // Track if this was triggered by touch
        isTouchInteraction = fromTouch;

        // If showing a different tooltip, hide the current one first
        if (activeTooltip && activeTooltip !== element) {
          tooltipContainer.classList.remove('show');
          tooltipOverlay.classList.remove('show');
        }

        const rect = element.getBoundingClientRect();
        tooltipContainer.innerHTML = html;
        tooltipContainer.classList.add('show');

        // Only show overlay for touch interactions (mobile)
        if (fromTouch) {
          tooltipOverlay.classList.add('show');
        }

        // Position tooltip
        const tooltipRect = tooltipContainer.getBoundingClientRect();
        let top = rect.bottom + 8;
        let left = rect.left;

        // Adjust for screen edges
        if (left + tooltipRect.width > window.innerWidth - 10) {
          left = window.innerWidth - tooltipRect.width - 10;
        }
        if (left < 10) left = 10;

        // If tooltip would go off bottom, show above
        if (top + tooltipRect.height > window.innerHeight - 100) {
          top = rect.top - tooltipRect.height - 8;
        }

        tooltipContainer.style.left = left + 'px';
        tooltipContainer.style.top = top + 'px';

        activeTooltip = element;
      }

      function hideTooltip() {
        tooltipContainer.classList.remove('show');
        tooltipOverlay.classList.remove('show');
        activeTooltip = null;
        isHoveringTooltip = false;
      }

      function scheduleHideTooltip() {
        // Don't hide if mouse is over the tooltip
        if (isHoveringTooltip) return;

        // Clear any existing timeout
        if (hideTimeout) {
          clearTimeout(hideTimeout);
        }

        // Delay hide to allow mouse to move to tooltip
        hideTimeout = setTimeout(() => {
          if (!isHoveringTooltip) {
            hideTooltip();
          }
        }, 100);
      }

      // Tooltip container hover events (for desktop)
      tooltipContainer.addEventListener('mouseenter', () => {
        isHoveringTooltip = true;
        if (hideTimeout) {
          clearTimeout(hideTimeout);
          hideTimeout = null;
        }
      });

      tooltipContainer.addEventListener('mouseleave', () => {
        isHoveringTooltip = false;
        scheduleHideTooltip();
      });

      // Event listeners for tooltips
      document.querySelectorAll('.tooltip-trigger').forEach(trigger => {
        const tooltipHtml = trigger.dataset.tooltip;

        // Touch events
        trigger.addEventListener('touchstart', (e) => {
          e.preventDefault();
          if (activeTooltip === trigger) {
            hideTooltip();
          } else {
            showTooltip(trigger, tooltipHtml, true); // fromTouch = true
          }
        }, { passive: false });

        // Mouse events (for desktop)
        trigger.addEventListener('mouseenter', () => {
          showTooltip(trigger, tooltipHtml);
        });

        trigger.addEventListener('mouseleave', () => {
          scheduleHideTooltip();
        });
      });

      // Close tooltip when clicking overlay
      tooltipOverlay.addEventListener('click', hideTooltip);
      tooltipOverlay.addEventListener('touchstart', hideTooltip);

      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight' || e.key === ' ') {
          e.preventDefault();
          if (!document.getElementById('next-btn').disabled) {
            nextStep();
          } else if (!document.getElementById('start-btn').disabled) {
            startAnimation();
          }
        } else if (e.key === 'r' || e.key === 'R') {
          reset();
        } else if (e.key === 'a' || e.key === 'A') {
          if (!document.getElementById('auto-btn').disabled || isPlaying) {
            autoPlay();
          }
        } else if (e.key === 'Escape') {
          hideTooltip();
        }
      });

      // Initialize
      updateUI();
    </script>
  </body>
</html>
